"use strict";function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}THREE.DRACOLoader=function(manager){THREE.Loader.call(this,manager),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}},THREE.DRACOLoader.prototype=Object.assign(Object.create(THREE.Loader.prototype),{constructor:THREE.DRACOLoader,setDecoderPath:function(path){return this.decoderPath=path,this},setDecoderConfig:function(config){return this.decoderConfig=config,this},setWorkerLimit:function(workerLimit){return this.workerLimit=workerLimit,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(url,onLoad,onProgress,onError){var _this=this,loader=new THREE.FileLoader(this.manager);loader.setPath(this.path),loader.setResponseType("arraybuffer"),"use-credentials"===this.crossOrigin&&loader.setWithCredentials(!0),loader.load(url,function(buffer){var taskConfig={attributeIDs:_this.defaultAttributeIDs,attributeTypes:_this.defaultAttributeTypes,useUniqueIDs:!1};_this.decodeGeometry(buffer,taskConfig).then(onLoad).catch(onError)},onProgress,onError)},decodeDracoFile:function(buffer,callback,attributeIDs,attributeTypes){var taskConfig={attributeIDs:attributeIDs||this.defaultAttributeIDs,attributeTypes:attributeTypes||this.defaultAttributeTypes,useUniqueIDs:!!attributeIDs};this.decodeGeometry(buffer,taskConfig).then(callback)},decodeGeometry:function(buffer,taskConfig){var _this2=this;for(var attribute in taskConfig.attributeTypes){var type=taskConfig.attributeTypes[attribute];void 0!==type.BYTES_PER_ELEMENT&&(taskConfig.attributeTypes[attribute]=type.name)}var worker,taskKey=JSON.stringify(taskConfig);if(THREE.DRACOLoader.taskCache.has(buffer)){var cachedTask=THREE.DRACOLoader.taskCache.get(buffer);if(cachedTask.key===taskKey)return cachedTask.promise;if(0===buffer.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var taskID=this.workerNextTaskID++,taskCost=buffer.byteLength,geometryPending=this._getWorker(taskID,taskCost).then(function(_worker){return worker=_worker,new Promise(function(resolve,reject){worker._callbacks[taskID]={resolve:resolve,reject:reject},worker.postMessage({type:"decode",id:taskID,taskConfig:taskConfig,buffer:buffer},[buffer])})}).then(function(message){return _this2._createGeometry(message.geometry)});return geometryPending.finally(function(){worker&&taskID&&_this2._releaseTask(worker,taskID)}),THREE.DRACOLoader.taskCache.set(buffer,{key:taskKey,promise:geometryPending}),geometryPending},_createGeometry:function(geometryData){var geometry=new THREE.BufferGeometry;geometryData.index&&geometry.setIndex(new THREE.BufferAttribute(geometryData.index.array,1));for(var i=0;i<geometryData.attributes.length;i++){var attribute=geometryData.attributes[i],name=attribute.name,array=attribute.array,itemSize=attribute.itemSize;geometry.setAttribute(name,new THREE.BufferAttribute(array,itemSize))}return geometry},_loadLibrary:function(url,responseType){var loader=new THREE.FileLoader(this.manager);return loader.setPath(this.decoderPath),loader.setResponseType(responseType),new Promise(function(resolve,reject){loader.load(url,resolve,void 0,reject)})},preload:function(){return this._initDecoder(),this},_initDecoder:function(){var _this3=this;if(this.decoderPending)return this.decoderPending;var useJS="object"!==("undefined"==typeof WebAssembly?"undefined":_typeof(WebAssembly))||"js"===this.decoderConfig.type,librariesPending=[];return useJS?librariesPending.push(this._loadLibrary("draco_decoder.js","text")):(librariesPending.push(this._loadLibrary("draco_wasm_wrapper.js","text")),librariesPending.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(librariesPending).then(function(libraries){var jsContent=libraries[0];useJS||(_this3.decoderConfig.wasmBinary=libraries[1]);var fn=THREE.DRACOLoader.DRACOWorker.toString(),body=["/* draco decoder */",jsContent,"","/* worker */",fn.substring(fn.indexOf("{")+1,fn.lastIndexOf("}"))].join("\n");_this3.workerSourceURL=URL.createObjectURL(new Blob([body]))}),this.decoderPending},_getWorker:function(taskID,taskCost){var _this4=this;return this._initDecoder().then(function(){var worker;_this4.workerPool.length<_this4.workerLimit?((worker=new Worker(_this4.workerSourceURL))._callbacks={},worker._taskCosts={},worker._taskLoad=0,worker.postMessage({type:"init",decoderConfig:_this4.decoderConfig}),worker.onmessage=function(e){var message=e.data;switch(message.type){case"decode":worker._callbacks[message.id].resolve(message);break;case"error":worker._callbacks[message.id].reject(message);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+message.type+'"')}},_this4.workerPool.push(worker)):_this4.workerPool.sort(function(a,b){return a._taskLoad>b._taskLoad?-1:1});return(worker=_this4.workerPool[_this4.workerPool.length-1])._taskCosts[taskID]=taskCost,worker._taskLoad+=taskCost,worker})},_releaseTask:function(worker,taskID){worker._taskLoad-=worker._taskCosts[taskID],delete worker._callbacks[taskID],delete worker._taskCosts[taskID]},debug:function(){console.log("Task load: ",this.workerPool.map(function(worker){return worker._taskLoad}))},dispose:function(){for(var i=0;i<this.workerPool.length;++i)this.workerPool[i].terminate();return this.workerPool.length=0,this}}),THREE.DRACOLoader.DRACOWorker=function(){var decoderConfig,decoderPending;function decodeAttribute(draco,decoder,dracoGeometry,attributeName,attributeType,attribute){var ptr,array,numComponents=attribute.num_components(),numValues=dracoGeometry.num_points()*numComponents;switch(attributeType){case Float32Array:var dataSize=4*numValues;ptr=draco._malloc(dataSize),decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_FLOAT32,dataSize,ptr),array=new Float32Array(draco.HEAPF32.buffer,ptr,numValues).slice(),draco._free(ptr);break;case Int8Array:ptr=draco._malloc(numValues),decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_INT8,numValues,ptr),geometryBuffer[attributeName]=new Int8Array(draco.HEAP8.buffer,ptr,numValues).slice(),draco._free(ptr);break;case Int16Array:dataSize=2*numValues;ptr=draco._malloc(dataSize),decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_INT16,dataSize,ptr),array=new Int16Array(draco.HEAP16.buffer,ptr,numValues).slice(),draco._free(ptr);break;case Int32Array:dataSize=4*numValues;ptr=draco._malloc(dataSize),decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_INT32,dataSize,ptr),array=new Int32Array(draco.HEAP32.buffer,ptr,numValues).slice(),draco._free(ptr);break;case Uint8Array:ptr=draco._malloc(numValues),decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_UINT8,numValues,ptr),geometryBuffer[attributeName]=new Uint8Array(draco.HEAPU8.buffer,ptr,numValues).slice(),draco._free(ptr);break;case Uint16Array:dataSize=2*numValues;ptr=draco._malloc(dataSize),decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_UINT16,dataSize,ptr),array=new Uint16Array(draco.HEAPU16.buffer,ptr,numValues).slice(),draco._free(ptr);break;case Uint32Array:dataSize=4*numValues;ptr=draco._malloc(dataSize),decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_UINT32,dataSize,ptr),array=new Uint32Array(draco.HEAPU32.buffer,ptr,numValues).slice(),draco._free(ptr);break;default:throw new Error("THREE.DRACOLoader: Unexpected attribute type.")}return{name:attributeName,array:array,itemSize:numComponents}}onmessage=function(e){var message=e.data;switch(message.type){case"init":decoderConfig=message.decoderConfig,decoderPending=new Promise(function(resolve){decoderConfig.onModuleLoaded=function(draco){resolve({draco:draco})},DracoDecoderModule(decoderConfig)});break;case"decode":var buffer=message.buffer,taskConfig=message.taskConfig;decoderPending.then(function(module){var draco=module.draco,decoder=new draco.Decoder,decoderBuffer=new draco.DecoderBuffer;decoderBuffer.Init(new Int8Array(buffer),buffer.byteLength);try{var geometry=function(draco,decoder,decoderBuffer,taskConfig){var dracoGeometry,decodingStatus,attributeIDs=taskConfig.attributeIDs,attributeTypes=taskConfig.attributeTypes,geometryType=decoder.GetEncodedGeometryType(decoderBuffer);if(geometryType===draco.TRIANGULAR_MESH)dracoGeometry=new draco.Mesh,decodingStatus=decoder.DecodeBufferToMesh(decoderBuffer,dracoGeometry);else{if(geometryType!==draco.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");dracoGeometry=new draco.PointCloud,decodingStatus=decoder.DecodeBufferToPointCloud(decoderBuffer,dracoGeometry)}if(!decodingStatus.ok()||0===dracoGeometry.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+decodingStatus.error_msg());var geometry={index:null,attributes:[]};for(var attributeName in attributeIDs){var attribute,attributeID,attributeType=self[attributeTypes[attributeName]];if(taskConfig.useUniqueIDs)attributeID=attributeIDs[attributeName],attribute=decoder.GetAttributeByUniqueId(dracoGeometry,attributeID);else{if(-1===(attributeID=decoder.GetAttributeId(dracoGeometry,draco[attributeIDs[attributeName]])))continue;attribute=decoder.GetAttribute(dracoGeometry,attributeID)}geometry.attributes.push(decodeAttribute(draco,decoder,dracoGeometry,attributeName,attributeType,attribute))}if(geometryType===draco.TRIANGULAR_MESH){var numIndices=3*dracoGeometry.num_faces(),dataSize=4*numIndices,ptr=draco._malloc(dataSize);decoder.GetTrianglesUInt32Array(dracoGeometry,dataSize,ptr);var index=new Uint32Array(draco.HEAPU32.buffer,ptr,numIndices).slice();draco._free(ptr),geometry.index={array:index,itemSize:1}}return draco.destroy(dracoGeometry),geometry}(draco,decoder,decoderBuffer,taskConfig),buffers=geometry.attributes.map(function(attr){return attr.array.buffer});geometry.index&&buffers.push(geometry.index.array.buffer),self.postMessage({type:"decode",id:message.id,geometry:geometry},buffers)}catch(error){console.error(error),self.postMessage({type:"error",id:message.id,error:error.message})}finally{draco.destroy(decoderBuffer),draco.destroy(decoder)}})}}},THREE.DRACOLoader.taskCache=new WeakMap,THREE.DRACOLoader.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},THREE.DRACOLoader.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},THREE.DRACOLoader.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},THREE.DRACOLoader.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};